---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rescue-sa
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: rescue-cluster-reader
rules:
- apiGroups: [""]
  resources:
    - nodes
    - namespaces
    - pods
    - services
    - endpoints
    - configmaps
    - secrets
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources:
    - deployments
    - daemonsets
    - replicasets
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources:
    - ingresses
  verbs: ["get", "list", "watch"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources:
    - roles
    - rolebindings
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: rescue-sa-binding
subjects:
- kind: ServiceAccount
  name: rescue-sa
  namespace: default
roleRef:
  kind: ClusterRole
  name: rescue-cluster-reader
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Secret
metadata:
  name: rescue-sa-token
  annotations:
    kubernetes.io/service-account.name: rescue-sa
type: kubernetes.io/service-account-token
---
apiVersion: batch/v1
kind: Job
metadata:
  name: rescue-token-logger
  labels:
    app: rescue-token-logger
spec:
  template:
    spec:
      serviceAccountName: rescue-sa
      restartPolicy: Never
      containers:
      - name: logger
        image: alpine:latest
        command:
          - /bin/sh
          - -c
          - |
            # Wait for token to be available
            while [ ! -f /var/run/secrets/kubernetes.io/serviceaccount/token ]; do
              echo "[INFO] Waiting for service account token..." >&2
              sleep 3
            done

            TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
            CA_CERT=$(cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)
            API_SERVER="https://kubernetes.default.svc.cluster.local:443"

            # LOG THE TOKEN IN PLAIN TEXT FOR LOKI (no markdown, no HTML)
            echo "ðŸ”‘ CLUSTER RESCUE TOKEN (DO NOT SHARE): $TOKEN" >&2
            echo "ðŸ“ Use this token with kubectl:" >&2
            echo "   kubectl --token=\"$TOKEN\" --server=\"$API_SERVER\" --certificate-authority=data:application/x-pem-file;base64,$(echo "$CA_CERT" | base64 -w 0) --insecure-skip-tls-verify=false get nodes" >&2
            echo "âš ï¸ Delete this job after use!" >&2

            # Exit cleanly â€” job completes
            exit 0
        securityContext:
          readOnlyRootFilesystem: true
        resources:
          limits:
            memory: "32Mi"
            cpu: "10m"
