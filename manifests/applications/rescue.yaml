---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rescue-sa
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: rescue-cluster-reader
rules:
- apiGroups: [""]
  resources: ["nodes", "namespaces", "pods", "services", "endpoints", "configmaps", "secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets", "replicasets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: rescue-sa-binding
subjects:
- kind: ServiceAccount
  name: rescue-sa
  namespace: default
roleRef:
  kind: ClusterRole
  name: rescue-cluster-reader
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: rescue-token-logger
  namespace: default
  labels:
    app: rescue-token-logger
spec:
  ttlSecondsAfterFinished: 600 # Optional: Cleans up the job 10 mins after completion
  template:
    spec:
      serviceAccountName: rescue-sa
      restartPolicy: Never
      containers:
      - name: logger
        image: alpine:latest
        command:
          - /bin/sh
          - -c
          - |
            # 1. Define standard mount path for Projected Volume tokens
            TOKEN_PATH="/var/run/secrets/kubernetes.io/serviceaccount/token"

            # 2. Wait for token (usually instant, but good practice)
            while [ ! -f "$TOKEN_PATH" ]; do
              echo "[INFO] Waiting for service account token..." >&2
              sleep 2
            done

            TOKEN=$(cat "$TOKEN_PATH")
            
            # 3. Output logic
            echo "============================================================" >&2
            echo "ðŸ”‘ CLUSTER RESCUE TOKEN (DO NOT SHARE):" >&2
            echo "" >&2
            echo "$TOKEN" >&2
            echo "" >&2
            echo "============================================================" >&2
            echo "ðŸ“ COPY-PASTE COMMAND (Insecure/Rescue Mode):" >&2
            echo "" >&2
            # Note: kubectl does not support inline base64 CA data in flags. 
            # Using --insecure-skip-tls-verify is standard for 'rescue' ops.
            echo "kubectl --token=\"$TOKEN\" --server=\"https://kubernetes.default.svc\" --insecure-skip-tls-verify=true get nodes" >&2
            echo "============================================================" >&2

        securityContext:
          readOnlyRootFilesystem: true
        resources:
          limits:
            memory: "64Mi"
            cpu: "50m"
